name: DevOps Assignment CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual 
    inputs:
      cleanup:
        description: 'Run cleanup job (destroy infrastructure)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.5.0
  TERRAGRUNT_VERSION: 0.50.0

jobs:
  # Job 1: Infrastructure Deployment
  infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    
    # Set outputs for the next job
    outputs:
      s3-bucket-name: ${{ steps.terraform-output.outputs.s3_bucket_id }}
      cloudfront-url: ${{ steps.terraform-output.outputs.cloudfront_url }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ› ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    - name: ğŸ“¦ Install Terragrunt
      run: |
        wget https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
        terragrunt --version
    
    - name: ğŸ—„ï¸ Setup Local Backend with Artifacts
      run: |
        echo "ğŸ—„ï¸ Using local backend with GitHub Actions artifacts for state persistence"
        echo "This ensures state is preserved between pipeline runs for up to 30 days"
        echo "âœ… State will be available for new pipeline triggers"

    - name: ğŸ” Terraform Format Check
      run: |
        cd terraform
        terraform fmt -check -recursive
      continue-on-error: true
    
    - name: ğŸ“‹ Terragrunt Plan
      working-directory: terragrunt/environments/dev
      run: |
        echo "ğŸ—„ï¸ Using local backend with artifact persistence"
        echo "ğŸ“‹ Initializing Terragrunt with local backend..."
        
        # The main terragrunt.hcl now uses local backend by default
        terragrunt init
        terragrunt plan -no-color
      env:
        TF_VAR_bucket_name: "devops-assignment-products-dev"
        TF_VAR_distribution_name: "devops-assignment-dev"
        TF_VAR_environment: "dev"
    
    - name: ğŸš€ Terragrunt Apply
      working-directory: terragrunt/environments/dev
      run: |
        echo "ğŸš€ Applying infrastructure changes..."
        echo "ğŸ—„ï¸ Using local backend configuration..."
        
        # The main terragrunt.hcl now uses local backend by default
        terragrunt init
        terragrunt apply -auto-approve -no-color
      env:
        TF_VAR_bucket_name: "devops-assignment-products-dev"
        TF_VAR_distribution_name: "devops-assignment-dev"
        TF_VAR_environment: "dev"
    
    - name: ğŸ“¤ Get Terraform Outputs
      id: terraform-output
      working-directory: terragrunt/environments/dev
      run: |
        S3_BUCKET=$(terragrunt output -raw s3_bucket_id)
        CLOUDFRONT_URL=$(terragrunt output -raw cloudfront_url)
        echo "s3_bucket_id=${S3_BUCKET}" >> $GITHUB_OUTPUT
        echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
        echo "Infrastructure outputs:"
        echo "S3 Bucket: ${S3_BUCKET}"
        echo "CloudFront URL: ${CLOUDFRONT_URL}"

    - name: ğŸ’¾ Upload State File
      uses: actions/upload-artifact@v4
      with:
        name: terraform-state
        path: |
          terragrunt/environments/dev/terraform.tfstate
          terragrunt/environments/dev/.terraform/
        retention-days: 30
  
  # Job 3: Cleanup (Optional - only on manual trigger)
  cleanup:
    name: ğŸ§¹ Cleanup Resources
    runs-on: ubuntu-latest
    needs: [infrastructure]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cleanup == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ› ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    - name: ğŸ“¦ Install Terragrunt
      run: |
        wget https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
    
    - name: ï¿½ Download Current State
      uses: actions/download-artifact@v4
      with:
        name: terraform-state
        path: terragrunt/environments/dev/
      continue-on-error: true
    
    - name: ï¿½ğŸ—‘ï¸ Terragrunt Destroy
      working-directory: terragrunt/environments/dev
      run: |
        echo "ğŸ—‘ï¸ Destroying infrastructure using local backend..."
        echo "ğŸ—„ï¸ Using local backend configuration..."
        
        # Initialize with current state and destroy
        terragrunt init
        terragrunt destroy -auto-approve -no-color
      env:
        TF_VAR_bucket_name: "devops-assignment-products-dev"
        TF_VAR_distribution_name: "devops-assignment-dev"
        TF_VAR_environment: "dev"
    
    - name: ğŸ§¹ Clean State Artifacts
      uses: geekyeggo/delete-artifact@v5
      with:
        name: terraform-state
      continue-on-error: true